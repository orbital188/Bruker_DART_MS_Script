'──────────────────────────────────────────────────────────────────────────────
'  Batch Mass-List exporter – memory-safe version
'──────────────────────────────────────────────────────────────────────────────
Option Explicit

'---------- helper ------------------------------------------------------------
Function Pad(n, w): Pad = Right(String(w,"0") & CStr(n), w): End Function

Sub ExportMassLists(ana)

    '----- 1. results folder --------------------------------------------------
    Dim dt: dt = Now
    Dim stamp: stamp = Right(Year(dt),2) & Pad(Month(dt),2) & Pad(Day(dt),2)
    Dim tcode: tcode = Pad(Hour(dt),2) & Pad(Minute(dt),2)

    Dim fso: Set fso = CreateObject("Scripting.FileSystemObject")
    Dim rawName: rawName = fso.GetBaseName(ana.Path)
    Dim outDir: outDir = fso.GetParentFolderName(ana.Path) & "\" & _
                         stamp & "_" & rawName & "_mass_list_analysis_" & tcode
    If Not fso.FolderExists(outDir) Then fso.CreateFolder outDir

    '----- 2. iterate over scans ---------------------------------------------
    Dim nScans: nScans = ana.Properties.SpectraCount
    Dim digits: digits = Len(CStr(nScans))

    Dim scanNo, lastIdx, spec, csv
    For scanNo = 1 To nScans

        '2a) add raw scan → Compound Spectra
        ana.Spectra.Add scanNo, daAuto                        'creates new Spectrum

        lastIdx = ana.Spectra.Count                           'index of the newcomer
        Set spec = ana.Spectra(lastIdx)

        '2b) peak-pick only THIS spectrum
        spec.MassListFind spec.FirstMass, spec.LastMass       'fills Mass List:contentReference[oaicite:2]{index=2}

        '2c) export Mass List
        csv = outDir & "\Scan_" & Pad(scanNo, digits) & ".csv"
        spec.ExportMassList csv, daCSV

        '2d) free memory immediately
        spec.MassListClear                                    'wipe peak list:contentReference[oaicite:3]{index=3}
        ana.Spectra.Delete lastIdx                            'remove Spectrum:contentReference[oaicite:4]{index=4}
        Set spec = Nothing
        If scanNo Mod 50 = 0 Then Application.DoEvents        'keeps UI responsive
    Next
End Sub
'======================  BATCH DRIVER  ========================================
Dim ana, done: done = 0
For Each ana In Application.Analyses           'all open *.d files
    ExportMassLists ana
    done = done + 1
Next

MsgBox "Export complete for " & done & " analyses.", vbInformation, "Mass-List batch"
'──────────────────────────────────────────────────────────────────────────────
